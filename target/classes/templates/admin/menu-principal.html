<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{complementoPagina/header :: head}">
    <title>Menu Principal | Marketing Pro</title>
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
</head>
<style>
    :root {
        --bg-main: #f8fafc;
        --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    body { background-color: var(--bg-main); font-family: 'Inter', sans-serif; }
    
    .main-content { min-height: 100vh; transition: all 0.3s; }
    
    /* Tarjetas de estad√≠sticas mejoradas */
    .stat-card {
        transition: transform 0.2s;
        border-radius: 12px;
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .table thead th {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        background-color: #f1f5f9;
    }
    
    /* Badges uniformes - mismo tama√±o fijo */
    .badge-estado {
        padding: 0.5em 1em;
        border-radius: 6px;
        font-weight: 500;
        min-width: 110px;
        display: inline-block;
        text-align: center;
        font-size: 0.75rem;
    }
    
    /* Uniformidad en las tarjetas de equipos */
    .team-card { border-radius: 12px; border: 1px solid #e2e8f0 !important; }
    .icon-box { width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; }
    
    /* Estilos para registro de asistencia */
    .btn-asistencia {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-entrada {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
    }
    
    .btn-entrada:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .btn-salida {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        color: white;
    }
    
    .btn-salida:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        color: white;
    }
    
    .estado-activo {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .registro-item {
        border-left: 3px solid #3b82f6;
        padding-left: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .hora-entrada { color: #10b981; font-weight: 600; }
    .hora-salida { color: #ef4444; font-weight: 600; }
    
    /* Precio mejorado */
    .precio-tag {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: #166534;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.95rem;
        border: 1px solid #bbf7d0;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .precio-tag::before {
        content: "S./";
        font-size: 0.75rem;
        font-weight: 600;
        opacity: 0.8;
    }
    
    /* Animaci√≥n para ganancias actualizadas */
    @keyframes pulse-green {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .ganancia-actualizada {
        animation: pulse-green 0.5s ease-in-out;
    }

    /* Estilos para FullCalendar */
    #calendar {
        max-width: 100%;
        height: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .fc {
        font-family: 'Inter', sans-serif;
    }

    .fc .fc-button-primary {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .fc .fc-button-primary:hover {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .fc .fc-button-primary.fc-button-active {
        background-color: #1d4ed8;
        border-color: #1d4ed8;
    }

    .fc .fc-event {
        border-radius: 6px;
        border: none;
    }

    .fc .fc-event-title {
        font-weight: 600;
        padding: 0.25rem 0.5rem;
    }

    .fc .fc-daygrid-day.fc-day-other {
        background-color: #f8fafc;
        opacity: 0.5;
    }

    .fc .fc-daygrid-day.fc-day-today {
        background-color: #eff6ff;
    }

    .fc .fc-daygrid-day:hover {
        background-color: #f1f5f9;
    }

    .fc .fc-col-header-cell {
        background-color: #f1f5f9;
        font-weight: 600;
        color: #1e293b;
        border-color: #e2e8f0;
    }

    .fc .fc-daygrid-day-number {
        color: #1e293b;
        font-weight: 500;
    }

    .calendar-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 2rem;
    }

    .reunion-badge {
        display: inline-block;
        background: #3788d8;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .reunion-popover {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        border: 1px solid #e2e8f0;
    }

    .reunion-popover-title {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .reunion-popover-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
        font-size: 0.85rem;
        color: #475569;
    }

    .reunion-popover-item i {
        color: #3b82f6;
        margin-top: 0.1rem;
        flex-shrink: 0;
    }

</style>

<body>
    <div th:replace="~{complementoPagina/header :: header}"></div>
    
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{complementoPagina/sidebar :: sidebar}"></div>
            
            <main class="main-content col-md-10 ms-sm-auto p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-dark mb-1">Menu Principal</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item active">Resumen general de la agencia</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="/api/reportes/ganancias-pdf" class="btn btn-success shadow-sm" title="Descargar reporte en PDF">
                            <i class="bi bi-file-pdf me-2"></i>Exportar PDF
                        </a>
                        <button class="btn btn-outline-secondary shadow-sm" data-bs-toggle="modal" data-bs-target="#reporteModal" title="Ver opciones de reporte">
                            <i class="bi bi-funnel me-2"></i>Filtros
                        </button>
                    </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="row g-4 mb-5">
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Equipos Activos</p>
                                        <h2 class="fw-bold mb-0" th:text="${#lists.size(equipos)}">0</h2>
                                    </div>
                                    <div class="icon-box bg-primary bg-opacity-10 rounded-3">
                                        <i class="bi bi-people-fill fs-3 text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Servicios</p>
                                        <h2 class="fw-bold mb-0" th:text="${#lists.size(servicios)}">0</h2>
                                    </div>
                                    <div class="icon-box bg-success bg-opacity-10 rounded-3">
                                        <i class="bi bi-cpu fs-3 text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Ganancias Hoy</p>
                                        <h2 class="fw-bold mb-0 text-success" id="gananciasHoy">
                                            S./ <span th:text="${#numbers.formatDecimal(totalGanancias != null ? totalGanancias : 0, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                                        </h2>
                                        <small class="text-success" th:if="${serviciosCompletadosHoy != null && serviciosCompletadosHoy > 0}">
                                            <i class="bi bi-arrow-up-circle me-1"></i>
                                            <span th:text="${serviciosCompletadosHoy}">0</span> servicios completados
                                        </small>
                                    </div>
                                    <div class="icon-box bg-warning bg-opacity-10 rounded-3">
                                        <i class="bi bi-currency-dollar fs-3 text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calendario de Reuniones -->
                <div class="row mb-5">
                    <div class="col-lg-8">
                        <div class="calendar-container">
                            <h5 class="fw-bold mb-3"><i class="bi bi-calendar-event me-2 text-primary"></i>Calendario de Reuniones</h5>
                            <div id="calendar"></div>
                        </div>
                    </div>

                    <!-- Panel de Reuniones del D√≠a -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-calendar-check me-2"></i>Reuniones Programadas</h6>
                            </div>
                            <div class="card-body">
                                <div id="reunionesHoyContainer">
                                    <p class="text-muted text-center py-3">Cargando reuniones...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Columna principal -->
                    <div class="col-lg-8">
                        <!-- Servicios Recientes -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-3 d-flex align-items-center justify-content-between">
                                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-list-task me-2"></i>Servicios Recientes</h6>
                                <div>
                                    <a th:href="@{/admin/servicios}" class="btn btn-light btn-sm fw-semibold me-2">Ver Todos</a>
                                    <form th:action="@{/admin/servicios/limpiar-todo}" method="post" style="display: inline;">
                                        <button type="submit" onclick="return confirm('¬øEliminar TODOS los servicios? Esta acci√≥n no se puede deshacer.')" 
                                                class="btn btn-danger btn-sm fw-semibold">
                                            <i class="bi bi-trash-fill me-1"></i>Eliminar todos
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table align-middle table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th class="ps-4">Servicio</th>
                                                <th>Estado</th>
                                                <th>Precio</th>
                                                <th class="text-end pe-4">Acci√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${#lists.isEmpty(servicios)}">
                                                <td colspan="4" class="text-center py-4 text-muted">
                                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                                    No hay servicios registrados
                                                </td>
                                            </tr>
                                            <tr th:each="servicio, iter : ${servicios}" th:if="${iter.index < 5}">
                                                <td class="ps-4">
                                                    <div class="fw-semibold text-dark" th:text="${servicio.nombre}">Nombre</div>
                                                    <small class="text-muted" th:text="${servicio.fechaCreacion != null ? #temporals.format(servicio.fechaCreacion, 'dd/MM/yyyy') : '-'}">Fecha</small>
                                                </td>
                                                <td>
                                                    <span th:if="${servicio.estado != null}" 
                                                          th:with="status=${servicio.estado.toString()}"
                                                          class="badge-estado" 
                                                          th:classappend="${status == 'COMPLETADO' ? 'bg-success-subtle text-success border border-success-subtle' : 
                                                                          (status == 'EN_PROCESO' ? 'bg-warning-subtle text-warning-emphasis border border-warning-subtle' : 
                                                                          (status == 'CANCELADO' ? 'bg-danger-subtle text-danger border border-danger-subtle' : 'bg-info-subtle text-info border border-info-subtle'))}"
                                                          th:text="${servicio.estado}">
                                                        Estado
                                                    </span>
                                                    <span th:if="${servicio.estado == null}" class="badge-estado bg-secondary">SIN ESTADO</span>
                                                </td>
                                                <td>
                                                    <span class="precio-tag" th:text="${servicio.precioBase != null ? #numbers.formatDecimal(servicio.precioBase, 1, 'COMMA', 2, 'POINT') : '0.00'}">0.00</span>
                                                </td>
                                                <td class="text-end pe-4">
                                                    <button class="btn btn-outline-primary btn-sm rounded-pill" 
                                                            th:if="${servicio.id != null && servicio.precioBase != null}"
                                                            th:onclick="'cambiarEstado(' + ${servicio.id} + ', ' + ${servicio.precioBase} + ')'">
                                                        <i class="bi bi-pencil-square me-1"></i>Estado
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-people me-2"></i>Equipos de Trabajo</h6>
                            </div>
                            <div class="card-body">
                                <div th:if="${#lists.isEmpty(equipos)}" class="text-center text-muted py-3">
                                    <p>No hay equipos registrados</p>
                                </div>
                                <div th:each="equipo : ${equipos}" class="team-card p-3 mb-3 bg-light">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold text-dark" th:text="${equipo.nombre}">Nombre Equipo</h6>
                                            <div class="small text-muted mb-2">
                                                <i class="bi bi-person-badge me-1"></i>
                                                L√≠der: <span th:text="${equipo.jefeEquipo != null && equipo.jefeEquipo.usuario != null && equipo.jefeEquipo.usuario.nombreCompleto != null ? equipo.jefeEquipo.usuario.nombreCompleto : 'Sin asignar'}">-</span>
                                            </div>
                                            <span class="badge bg-white text-dark border shadow-sm">
                                                <i class="bi bi-people-fill me-1 text-primary"></i>
                                                <span th:text="${equipo.integrantes != null ? #lists.size(equipo.integrantes) : 0}">0</span> Miembros
                                            </span>
                                        </div>
                                        <a th:href="@{/admin/equipos/{id}(id=${equipo.id})}" class="btn btn-primary btn-sm rounded-circle">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen de Ganancias del D√≠a -->
                        <div class="card border-0 shadow-sm mb-4 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="card-body text-white">
                                <h6 class="fw-bold mb-3"><i class="bi bi-graph-up me-2"></i>Resumen Financiero Hoy</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Servicios Completados:</span>
                                    <span class="fw-bold" id="serviciosCompletados" th:text="${serviciosCompletadosHoy != null ? serviciosCompletadosHoy : '0'}">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Total Ingresos:</span>
                                    <span class="fw-bold fs-5" id="totalIngresosSidebar">
                                        S./ <span th:text="${#numbers.formatDecimal(totalGanancias != null ? totalGanancias : 0, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                                    </span>
                                </div>
                                <hr class="border-white opacity-25">
                                <div class="text-center">
                                    <small class="opacity-75">Actualizado: <span id="horaActualizacion">--:--</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        let gananciasActuales = /*[[${totalGanancias != null ? totalGanancias : 0}]]*/ 0;
        let serviciosCompletados = /*[[${serviciosCompletadosHoy != null ? serviciosCompletadosHoy : 0}]]*/ 0;
        /*]]>*/
        
        function cambiarEstado(id, precioServicio) {
            const estados = ['PENDIENTE', 'EN_PROCESO', 'COMPLETADO', 'CANCELADO'];
            const nuevoEstado = prompt('Seleccione nuevo estado:\n0: Pendiente\n1: En Proceso\n2: Completado\n3: Cancelado');
            
            if (nuevoEstado !== null && nuevoEstado >= 0 && nuevoEstado < 4) {
                const estadoSeleccionado = estados[nuevoEstado];
                
                // Si cambia a COMPLETADO, sumar a ganancias del d√≠a
                if (estadoSeleccionado === 'COMPLETADO') {
                    gananciasActuales += parseFloat(precioServicio);
                    serviciosCompletados++;
                    actualizarGananciasUI();
                    mostrarNotificacion('¬°Servicio Completado!', 'Se agregaron S./ ' + precioServicio + ' a las ganancias de hoy');
                }
                
                fetch('/admin/servicios/' + id + '/estado?estado=' + estadoSeleccionado, {
                    method: 'POST'
                }).then(response => {
                    if(response.ok) {
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert("Error al actualizar el estado");
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert("Error al actualizar el estado");
                });
            }
        }
        
        function actualizarGananciasUI() {
            const formateado = gananciasActuales.toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            const gananciasEl = document.getElementById('gananciasHoy');
            if (gananciasEl) {
                gananciasEl.innerHTML = 'S./ <span>' + formateado + '</span>';
                gananciasEl.classList.add('ganancia-actualizada');
                setTimeout(() => gananciasEl.classList.remove('ganancia-actualizada'), 500);
            }
            
            const sidebarEl = document.getElementById('totalIngresosSidebar');
            if (sidebarEl) {
                sidebarEl.innerHTML = 'S./ <span>' + formateado + '</span>';
            }
            
            const completadosEl = document.getElementById('serviciosCompletados');
            if (completadosEl) {
                completadosEl.textContent = serviciosCompletados;
            }
            
            const ahora = new Date();
            const horaStr = ahora.getHours().toString().padStart(2, '0') + ':' + 
                           ahora.getMinutes().toString().padStart(2, '0');
            const horaEl = document.getElementById('horaActualizacion');
            if (horaEl) {
                horaEl.textContent = horaStr;
            }
        }
        
        function mostrarNotificacion(titulo, mensaje) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = 
                '<div class="toast show" role="alert">' +
                '<div class="toast-header bg-success text-white">' +
                '<i class="bi bi-check-circle me-2"></i>' +
                '<strong class="me-auto">' + titulo + '</strong>' +
                '<button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.parentElement.remove()"></button>' +
                '</div>' +
                '<div class="toast-body">' + mensaje + '</div>' +
                '</div>';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Actualizar ganancias peri√≥dicamente
        setInterval(() => {
            fetch('/admin/ganancias-hoy')
                .then(response => response.json())
                .then(data => {
                    if (data.total !== undefined && data.total !== gananciasActuales) {
                        gananciasActuales = data.total;
                        serviciosCompletados = data.serviciosCompletados;
                        actualizarGananciasUI();
                    }
                })
                .catch(error => console.error('Error:', error));
        }, 30000);
        
        // ========== INICIALIZACI√ìN DE FULLCALENDAR ==========
        document.addEventListener('DOMContentLoaded', function() {
            inicializarCalendario();
        });
        
        function inicializarCalendario() {
            var calendarEl = document.getElementById('calendar');
            
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'D√≠a',
                    list: 'Lista'
                },
                events: function(info, successCallback, failureCallback) {
                    // Cargar eventos desde el API
                    fetch('/admin/reuniones/api/all')
                        .then(response => response.json())
                        .then(data => {
                            const events = data.map(reunion => ({
                                id: reunion.id,
                                title: reunion.title,
                                start: reunion.start,
                                end: reunion.end,
                                backgroundColor: reunion.color || '#3788d8',
                                borderColor: reunion.color || '#3788d8',
                                extendedProps: {
                                    description: reunion.description,
                                    location: reunion.location,
                                    equipoNombre: reunion.equipoNombre,
                                    organizadorNombre: reunion.organizadorNombre,
                                    notificarJefe: reunion.notificarJefe
                                }
                            }));
                            successCallback(events);
                            actualizarReunionesHoy(data);
                        })
                        .catch(error => {
                            console.error('Error al cargar reuniones:', error);
                            failureCallback(error);
                        });
                },
                eventClick: function(info) {
                    mostrarDetallesReunion(info.event);
                },
                dateClick: function(info) {
                    mostrarReunionesDelDia(info.dateStr);
                }
            });
            
            calendar.render();
        }
        
        function actualizarReunionesHoy(reuniones) {
            const hoy = new Date().toISOString().split('T')[0];
            const reunionesHoy = reuniones.filter(r => r.start && r.start.split('T')[0] === hoy);
            
            const container = document.getElementById('reunionesHoyContainer');
            if (reunionesHoy.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No hay reuniones hoy</p>';
            } else {
                let html = '';
                reunionesHoy.forEach((reunion, index) => {
                    const hora = new Date(reunion.start).toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
                    html += `
                        <div class="mb-3 pb-3 border-bottom" style="cursor: pointer;" onclick="mostrarDetallesReunionPopup(this)">
                            <div class="d-flex align-items-start gap-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold text-dark">${reunion.title}</h6>
                                    <small class="text-muted d-block mb-1"><i class="bi bi-clock me-1"></i>${hora}</small>
                                    <small class="text-muted d-block mb-1"><i class="bi bi-geo-alt me-1"></i>${reunion.location || 'Sin lugar'}</small>
                                    <small class="text-muted d-block"><i class="bi bi-people me-1"></i>${reunion.equipoNombre || 'Sin equipo'}</small>
                                </div>
                                <span class="badge bg-primary-subtle text-primary">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </div>
                            <div class="mt-2" style="display: none;">
                                <small class="text-secondary">${reunion.description || 'Sin descripci√≥n'}</small>
                                <br>
                                <small class="text-secondary">Organizador: ${reunion.organizadorNombre || 'Sin especificar'}</small>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }
        
        function mostrarDetallesReunion(event) {
            const props = event.extendedProps;
            const inicio = new Date(event.start).toLocaleString('es-PE');
            const fin = new Date(event.end).toLocaleString('es-PE');
            
            alert(
                `üìÖ ${event.title}\n\n` +
                `‚è∞ Inicio: ${inicio}\n` +
                `‚èπÔ∏è  Fin: ${fin}\n` +
                `üìç Lugar: ${props.location || 'Sin especificar'}\n` +
                `üë• Equipo: ${props.equipoNombre || 'Sin especificar'}\n` +
                `üë§ Organizador: ${props.organizadorNombre || 'Sin especificar'}\n` +
                `${props.description ? '\nüìù ' + props.description : ''}`
            );
        }
        
        function mostrarDetallesReunionPopup(element) {
            const detalles = element.querySelector('div[style*="display: none"]');
            if (detalles) {
                detalles.style.display = detalles.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function mostrarReunionesDelDia(dateStr) {
            console.log('Reuniones del d√≠a: ' + dateStr);
        }
    </script>

    <!-- Modal para opciones de reporte -->
    <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title fw-bold text-white" id="reporteModalLabel">
                        <i class="bi bi-file-pdf me-2"></i>Opciones de Reporte
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">Selecciona el tipo de reporte que deseas descargar:</p>
                    
                    <div class="d-grid gap-2">
                        <!-- Reporte de hoy -->
                        <a href="#" onclick="descargarReportePorFecha(new Date())" class="btn btn-outline-primary d-flex align-items-center justify-content-between p-3">
                            <div class="text-start">
                                <div class="fw-bold">Reporte de Hoy</div>
                                <small class="text-muted">Ganancias del d√≠a actual</small>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <!-- Reporte total -->
                        <a href="/api/reportes/ganancias-pdf" class="btn btn-success d-flex align-items-center justify-content-between p-3">
                            <div class="text-start">
                                <div class="fw-bold text-white">Reporte Total</div>
                                <small class="text-white-50">Todas las ganancias registradas</small>
                            </div>
                            <i class="bi bi-chevron-right text-white"></i>
                        </a>

                        <!-- Reporte personalizado -->
                        <button class="btn btn-outline-secondary d-flex align-items-center justify-content-between p-3" onclick="abrirSelectorFecha()">
                            <div class="text-start">
                                <div class="fw-bold">Reporte Personalizado</div>
                                <small class="text-muted">Selecciona una fecha espec√≠fica</small>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Selector de fecha (oculto inicialmente) -->
                    <div id="selectorFecha" style="display: none; margin-top: 1rem;">
                        <label class="form-label fw-bold">Selecciona una fecha:</label>
                        <div class="input-group">
                            <input type="date" id="fechaReporte" class="form-control">
                            <a href="#" onclick="descargarReporteFecha()" class="btn btn-primary">
                                <i class="bi bi-download"></i> Descargar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function abrirSelectorFecha() {
            document.getElementById('selectorFecha').style.display = 
                document.getElementById('selectorFecha').style.display === 'none' ? 'block' : 'none';
        }

        function descargarReportePorFecha(fecha) {
            const anio = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            const fechaFormato = anio + '-' + mes + '-' + dia;
            window.location.href = '/api/reportes/ganancias-por-fecha?fecha=' + fechaFormato;
        }

        function descargarReporteFecha() {
            const fecha = document.getElementById('fechaReporte').value;
            if (!fecha) {
                alert('Por favor selecciona una fecha');
                return;
            }
            window.location.href = '/api/reportes/ganancias-por-fecha?fecha=' + fecha;
        }
    </script>
</body>
</html>
