<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{complementoPagina/header :: head}">
    <title>Control de Personal | Marketing Pro</title>
</head>
<style>
    :root {
        --bg-main: #f8fafc;
        --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    body { background-color: var(--bg-main); font-family: 'Inter', sans-serif; }
    
    .main-content { min-height: 100vh; transition: all 0.3s; }
    
    .stat-card {
        transition: transform 0.2s;
        border-radius: 12px;
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .btn-asistencia {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-entrada {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
    }
    
    .btn-entrada:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .btn-salida {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        color: white;
    }
    
    .btn-salida:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        color: white;
    }
    
    .estado-activo {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .registro-item {
        border-left: 3px solid #3b82f6;
        padding-left: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .hora-entrada { color: #10b981; font-weight: 600; }
    .hora-salida { color: #ef4444; font-weight: 600; }
    
    .icon-box { width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; }
</style>

<body>
    <div th:replace="~{complementoPagina/header :: header}"></div>
    
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{complementoPagina/sidebar :: sidebar}"></div>
            
            <main class="main-content col-md-10 ms-sm-auto p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-dark mb-1">Control de Personal</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item active">Gestión de asistencia y personal</li>
                            </ol>
                        </nav>
                    </div>
                    
                    <!-- Date Filter Section -->
                    <div class="d-flex align-items-center gap-2">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filtrarPorFecha('ayer')">
                                <i class="bi bi-arrow-left"></i> Ayer
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="filtrarPorFecha('hoy')">
                                <i class="bi bi-calendar-check"></i> Hoy
                            </button>
                        </div>
                        <input type="date" id="fechaFiltro" class="form-control form-control-sm" 
                               style="width: auto;" th:value="${fechaSeleccionada}"
                               onchange="filtrarPorFechaPersonalizada()">
                    </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="row g-4 mb-5">
                    <div class="col-xl-4 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Personal Presente</p>
                                        <h2 class="fw-bold mb-0" th:text="${personalPresente != null ? personalPresente : 0}">0</h2>
                                    </div>
                                    <div class="icon-box bg-success bg-opacity-10 rounded-3">
                                        <i class="bi bi-check-circle fs-3 text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Total Registros</p>
                                        <h2 class="fw-bold mb-0 text-info">
                                            <span th:text="${totalRegistrosHoy != null ? totalRegistrosHoy : 0}">0</span>
                                        </h2>
                                    </div>
                                    <div class="icon-box bg-info bg-opacity-10 rounded-3">
                                        <i class="bi bi-hourglass-split fs-3 text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-md-6">
                        <div class="card stat-card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted small fw-bold mb-1 text-uppercase">Fecha Actual</p>
                                        <h6 class="fw-bold mb-0" id="fechaActual"></h6>
                                    </div>
                                    <div class="icon-box bg-primary bg-opacity-10 rounded-3">
                                        <i class="bi bi-calendar-event fs-3 text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Columna principal -->
                    <div class="col-lg-8">
                        <!-- Registro de Asistencia -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-3 d-flex align-items-center justify-content-between">
                                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-clock-history me-2"></i>Registro de Asistencia</h6>
                                <span class="estado-activo" th:if="${asistenciaActiva != null}">
                                    <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i>En turno
                                </span>
                                <span class="badge bg-secondary" th:if="${asistenciaActiva == null}">Fuera de turno</span>
                            </div>
                            <div class="card-body">
                                <!-- Botones de entrada/salida -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <form th:action="@{/admin/asistencia/entrada}" method="post">
                                            <button type="submit" class="btn btn-asistencia btn-entrada w-100">
                                                <i class="bi bi-box-arrow-in-right me-2"></i>Registrar Entrada
                                            </button>
                                        </form>
                                    </div>
                                    <div class="col-md-6">
                                        <form th:action="@{/admin/asistencia/salida}" method="post">
                                            <button type="submit" class="btn btn-asistencia btn-salida w-100">
                                                <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Historial de hoy -->
                                <h6 class="fw-bold text-dark mb-3">
                                    Historial 
                                    <span th:if="${fechaSeleccionada != null}" class="text-muted small">
                                        - <span th:text="${fechaSeleccionada}"></span>
                                    </span>
                                </h6>
                                <div th:if="${#lists.isEmpty(historialHoy)}" class="text-center text-muted py-4">
                                    <i class="bi bi-calendar-x fs-1"></i>
                                    <p class="mb-0 mt-2">No hay registros de asistencia para esta fecha</p>
                                </div>
                                <div th:each="registro : ${historialHoy}" class="registro-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold" th:text="${registro.integranteName}">Nombre</div>
                                            <small class="text-muted">
                                                <span class="hora-entrada" th:if="${registro.horaEntrada != null}">
                                                    <i class="bi bi-arrow-right-circle me-1"></i>
                                                    <span th:text="${#temporals.format(registro.horaEntrada, 'HH:mm')}">08:00</span>
                                                </span>
                                                <span th:if="${registro.horaSalida != null}" class="ms-2 hora-salida">
                                                    <i class="bi bi-arrow-left-circle me-1"></i>
                                                    <span th:text="${#temporals.format(registro.horaSalida, 'HH:mm')}">17:00</span>
                                                </span>
                                                <span th:if="${registro.horaSalida == null}" class="ms-2 text-warning">
                                                    <i class="bi bi-hourglass-split me-1"></i>En progreso
                                                </span>
                                                <span class="ms-2 text-primary">
                                                    <i class="bi bi-stopwatch me-1"></i>
                                                    <span th:text="${registro.tiempoActivo}">--</span>
                                                </span>
                                            </small>
                                        </div>
                                        <span class="badge" 
                                              th:classappend="${registro.estado == 'PRESENTE' ? 'bg-success' : (registro.estado == 'TARDANZA' ? 'bg-warning' : 'bg-danger')}"
                                              th:text="${registro.estadoFormatted}">Estado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar - Información adicional -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-info-circle me-2"></i>Información de Hoy</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold">Hora Actual</label>
                                    <p class="fw-bold text-dark mb-0" id="horaActual">--:--:--</p>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold">Total de Registros</label>
                                    <p class="fw-bold text-dark mb-0" th:text="${totalRegistrosHoy != null ? totalRegistrosHoy : 0}">0</p>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold">Personal Completo</label>
                                    <p class="fw-bold text-success mb-0">
                                        <i class="bi bi-check-circle me-1"></i>
                                        <span th:text="${totalRegistrosHoy != null && totalRegistrosHoy > 0 ? 'Presente' : 'Sin registros'}">-</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen estadísticas -->
                        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; overflow: hidden;">
                            <div class="card-body text-white p-4">
                                <h6 class="fw-bold mb-4 d-flex align-items-center" style="font-size: 1.1rem;">
                                    <i class="bi bi-graph-up me-2" style="font-size: 1.3rem;"></i>Resumen del Día
                                </h6>
                                
                                <!-- Entrada Temprana -->
                                <div class="mb-4 pb-3 border-bottom border-white border-opacity-25">
                                    <div class="small text-white-50 mb-2" style="font-size: 0.85rem;">Entrada Más Temprana</div>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span style="font-size: 1.8rem; font-weight: 700;" id="entradaTemprana">--:--</span>
                                        <i class="bi bi-arrow-right-circle" style="font-size: 1.5rem; opacity: 0.7;"></i>
                                    </div>
                                </div>
                                
                                <!-- Salida Tardía -->
                                <div class="mb-4">
                                    <div class="small text-white-50 mb-2" style="font-size: 0.85rem;">Salida Más Tardía</div>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span style="font-size: 1.8rem; font-weight: 700;" id="salidaTardia">--:--</span>
                                        <i class="bi bi-arrow-left-circle" style="font-size: 1.5rem; opacity: 0.7;"></i>
                                    </div>
                                </div>
                                
                                <!-- Línea divisora -->
                                <hr class="border-white opacity-25 my-3">
                                
                                <!-- Estadísticas -->
                                <small class="opacity-75 d-block text-center" style="font-size: 0.8rem;">
                                    <i class="bi bi-clock-history me-1"></i>Estadísticas actualizadas en tiempo real
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Actualizar hora actual en zona horaria de Perú
        function actualizarHora() {
            const ahora = new Date();
            // Convertir a hora de Perú (UTC-5)
            const horaPeruUTC = new Date(ahora.toLocaleString('en-US', { timeZone: 'America/Lima' }));
            const horaStr = horaPeruUTC.getHours().toString().padStart(2, '0') + ':' + 
                           horaPeruUTC.getMinutes().toString().padStart(2, '0') + ':' +
                           horaPeruUTC.getSeconds().toString().padStart(2, '0');
            const horaEl = document.getElementById('horaActual');
            if (horaEl) {
                horaEl.textContent = horaStr;
            }
        }
        
        // Calcular entrada más temprana y salida más tardía
        function actualizarResumenDia() {
            const horaEntradaElements = document.querySelectorAll('.hora-entrada');
            const horaSalidaElements = document.querySelectorAll('.hora-salida');
            
            let entradaMinima = null;
            let salidaMaxima = null;
            
            // Buscar entrada más temprana
            horaEntradaElements.forEach(el => {
                const texto = el.textContent.trim();
                const hora = texto.replace(/[^0-9:]/g, ''); // Extrae HH:mm
                if (hora) {
                    if (!entradaMinima || hora < entradaMinima) {
                        entradaMinima = hora;
                    }
                }
            });
            
            // Buscar salida más tardía
            horaSalidaElements.forEach(el => {
                const texto = el.textContent.trim();
                const hora = texto.replace(/[^0-9:]/g, ''); // Extrae HH:mm
                if (hora) {
                    if (!salidaMaxima || hora > salidaMaxima) {
                        salidaMaxima = hora;
                    }
                }
            });
            
            // Actualizar elementos
            const entradaEl = document.getElementById('entradaTemprana');
            const salidaEl = document.getElementById('salidaTardia');
            
            if (entradaEl) {
                entradaEl.textContent = entradaMinima || '--:--';
            }
            if (salidaEl) {
                salidaEl.textContent = salidaMaxima || '--:--';
            }
        }
        
        // Actualizar fecha actual en zona horaria de Perú
        function actualizarFecha() {
            const ahora = new Date();
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Lima' };
            const fechaStr = ahora.toLocaleDateString('es-PE', opciones);
            const fechaEl = document.getElementById('fechaActual');
            if (fechaEl) {
                fechaEl.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);
            }
        }
        
        // Filtrar por fecha (hoy o ayer)
        function filtrarPorFecha(opcion) {
            const ahora = new Date();
            // Obtener fecha en Perú
            const fechaPeru = new Date(ahora.toLocaleString('en-US', { timeZone: 'America/Lima' }));
            
            let fecha;
            if (opcion === 'hoy') {
                fecha = fechaPeru;
            } else if (opcion === 'ayer') {
                fecha = new Date(fechaPeru);
                fecha.setDate(fecha.getDate() - 1);
            }
            
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            const fechaStr = `${year}-${month}-${day}`;
            
            window.location.href = '/admin/control-personal?fecha=' + fechaStr;
        }
        
        // Filtrar por fecha personalizada desde el calendario
        function filtrarPorFechaPersonalizada() {
            const fechaInput = document.getElementById('fechaFiltro');
            if (fechaInput && fechaInput.value) {
                window.location.href = '/admin/control-personal?fecha=' + fechaInput.value;
            }
        }
        
        // Inicializar
        actualizarHora();
        actualizarFecha();
        actualizarResumenDia();
        
        // Actualizar hora cada segundo
        setInterval(actualizarHora, 1000);
        
        // Actualizar resumen del día cada 5 segundos (por si se agregan nuevos registros)
        setInterval(actualizarResumenDia, 5000);
    </script>
</body>
</html>
